<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">






  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-center-atom.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.0">


  <link rel="mask-icon" href="/images/logo.png?v=6.4.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.4.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="背景一天产品大大向 boss 汇报完研发成果和产品业绩产出，若有所思的走出来，劲直向我走过来，嘴角微微上扬。产品大大：boss 对我们的研发成果挺满意的，balabala…（内心 OS：不听，讲重点）产品大大：咱们的客服 IM 桌面客户端现在已经有能力做到 1 对多接待在线访客了，后面我们想要将专项问题访客在当前接待客服不能解决的情况下，可以拉专项客服发起群聊。我：嗯，这个想法不错，专项客服还能一">
<meta name="keywords" content="javascript html5">
<meta property="og:type" content="article">
<meta property="og:title" content="realize-at">
<meta property="og:url" content="https://wuwhs.gitee.io/2022/09/15/realize-at/index.html">
<meta property="og:site_name" content="wuwh&#39;s blog">
<meta property="og:description" content="背景一天产品大大向 boss 汇报完研发成果和产品业绩产出，若有所思的走出来，劲直向我走过来，嘴角微微上扬。产品大大：boss 对我们的研发成果挺满意的，balabala…（内心 OS：不听，讲重点）产品大大：咱们的客服 IM 桌面客户端现在已经有能力做到 1 对多接待在线访客了，后面我们想要将专项问题访客在当前接待客服不能解决的情况下，可以拉专项客服发起群聊。我：嗯，这个想法不错，专项客服还能一">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662389649885-df19671d-6b75-4375-8ea1-310481544199.gif">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662389674758-aec15344-10ed-40a0-be3c-34cd2cde513b.gif">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662389710497-a13651e7-3f6e-40d5-82dd-f2f4b9ad5901.gif">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662389727309-4831ce20-3bea-4b0c-9bec-86219a9c6427.gif">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662389742937-1b7b8b0c-2e1d-482a-8e45-f86b3c01620a.gif">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/jpeg/22627045/1663148689420-1c042136-3b5a-4f15-ab7f-0c706a62568e.jpeg">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/22627045/1662215604275-69e9f544-0b5a-4ba1-acf7-2d6a49928d03.png">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/22627045/1662216141776-85c105ca-898d-4821-b132-cd703eaab3df.png">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662435977354-b19ed561-61ec-4d8f-a184-9ae73f1f9b07.gif">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662436107528-1001e4af-e644-4571-8d26-ee085792e019.gif">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662436465512-d56fa927-a301-4e5a-b039-5e32c4443b07.gif">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662390599870-23189fbe-5149-43dc-8492-5d06e425464e.gif">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/jpeg/22627045/1662446157651-fd9d9bad-f924-4c19-b706-7b94d20751e8.jpeg">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662448203808-f82a4bb4-6eaf-4977-983e-42209e1b1c15.gif">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662449255433-9315d09c-e752-4ffb-a975-a54c856796e5.gif">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662453084252-763866a8-f74d-4938-ba88-bbc2fbf85920.gif">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662456538724-b365a830-e9dc-4472-aa8f-07e69371008c.gif">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662457953619-1679fb5f-23fb-43cb-b34a-54d1b3b0c4df.gif">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662462012337-424061e8-e1fc-4cbb-8c49-b6072ca68056.gif">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662894067034-48b18544-3caf-4c99-91aa-9fa3207eafb4.gif">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662903500575-0654dcc3-7084-4f44-ad79-e535855ebe8b.gif">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/22627045/1662904506911-91a30004-51d1-4dd8-8d03-5f7743d9caf4.png">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/22627045/1662904530240-a2695b2a-09bf-40cb-b75c-1f04e862b0fc.png">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/jpeg/22627045/1663151006797-58eaa2f3-bf49-4ff3-a493-fff785bfa05a.jpeg">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662907721684-7990ab06-9e4c-4c6c-b67b-ad04ef8a55c6.gif">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662908992043-444da205-b539-4036-b02e-6c1672e64f00.gif">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662909400591-181e6928-75f6-40a9-80a2-6f163109b91d.gif">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662910427167-f2a84f0b-ff53-47e1-864e-38f05e15bfb4.gif">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1663148352142-96a6a343-c4f3-4185-9b7b-b6724faf9e9b.gif">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662968166386-06ffeb53-6b4a-4a4d-8281-26bb8f3838e1.gif">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662969574165-f5ad5028-0b3c-4a82-a70f-8d978cf19362.gif">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662977831761-d5da8f13-d551-454a-b69f-be6475114777.gif">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/png/22627045/1662977805511-ffbb8962-4456-42fe-917c-ed310575d9b8.png">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662978608482-02437102-37b2-45c2-9b98-042ba882c5c1.gif">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662978794016-4b5c68bf-d7e6-4765-a19d-029bce17351f.gif">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662978984982-ce1af8a4-16a6-4aa0-8111-baa4e25bc5f8.gif">
<meta property="og:updated_time" content="2022-09-27T03:58:43.967Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="realize-at">
<meta name="twitter:description" content="背景一天产品大大向 boss 汇报完研发成果和产品业绩产出，若有所思的走出来，劲直向我走过来，嘴角微微上扬。产品大大：boss 对我们的研发成果挺满意的，balabala…（内心 OS：不听，讲重点）产品大大：咱们的客服 IM 桌面客户端现在已经有能力做到 1 对多接待在线访客了，后面我们想要将专项问题访客在当前接待客服不能解决的情况下，可以拉专项客服发起群聊。我：嗯，这个想法不错，专项客服还能一">
<meta name="twitter:image" content="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662389649885-df19671d-6b75-4375-8ea1-310481544199.gif">






  <link rel="canonical" href="https://wuwhs.gitee.io/2022/09/15/realize-at/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>realize-at | wuwh's blog</title>
  






  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?fa314f7747528620032d3194b7fccc9a";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta custom-logo">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">wuwh's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <h1 class="site-subtitle" itemprop="description">Make progress every day</h1>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签<span class="badge">39</span></a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">
    <a href="/categories/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分类<span class="badge">12</span></a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档<span class="badge">71</span></a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  
    <div class="reading-progress-bar"></div>
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://wuwhs.gitee.io/2022/09/15/realize-at/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="wuwhs">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="wuwh's blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">realize-at
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2022-09-15 17:08:30" itemprop="dateCreated datePublished" datetime="2022-09-15T17:08:30+08:00">2022-09-15</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2022-09-27 11:58:43" itemprop="dateModified" datetime="2022-09-27T11:58:43+08:00">2022-09-27</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>一天产品大大向 boss 汇报完研发成果和产品业绩产出，若有所思的走出来，劲直向我走过来，嘴角微微上扬。<br>产品大大：boss 对我们的研发成果挺满意的，balabala…（内心 OS：不听，讲重点）<br>产品大大：咱们的客服 IM 桌面客户端现在已经有能力做到 1 对多接待在线访客了，后面我们想要将专项问题访客在当前接待客服不能解决的情况下，可以拉专项客服发起群聊。<br>我：嗯，这个想法不错，专项客服还能一眼看到之前对话上下文，访客还无须重新发起聊天。<br>哒哒哒，功能做完了，两周后上线验收，客户很满意，boss 在群里也点了个 👍🏻。<br>产品大大又来了：嗯，这个功能不错，我们也支持给客服自己群聊吧，有助于客服群体沟通和问题反馈。<br>我：嗯，这个想法也不错，群聊的内容也有助于后期的用户声音数据挖掘。<br>哐哐哐，做好了，上线，调整好心态，静等被各路大佬 👍🏻 淹没。<br>客服 A：搞毛啊，你们群聊都不给个@功能，我怎么 diao 你们研发啊。<br>客服 B/C/D：➕10086。<br>我：。。。<br>哈哈哈，上面的虚拟场景纯属好玩，下面就怎样完美的实现一个@功能展开，包教包会。<br>在进入正题之前，咱们先预备一些对光标选区的“基操”知识。而对光标选区的操作在页面上的元素大致分为两大类：text/textarea 文本输入框元素和富文本元素。下面分别对一些常用 API 进行简单介绍。</p>
<h2 id="text-textarea-文本输入框中操作光标选区"><a href="#text-textarea-文本输入框中操作光标选区" class="headerlink" title="text/textarea 文本输入框中操作光标选区"></a>text/textarea 文本输入框中操作光标选区</h2><p>首先看这类操作方式，几乎可以不用 <code>Selection</code>和 <code>Range</code>相关 API，使用的是文本输入框元素原生方法。</p>
<h3 id="主动选中某一区域"><a href="#主动选中某一区域" class="headerlink" title="主动选中某一区域"></a>主动选中某一区域</h3><p>主动选中在文本输入框元素某一区域可以使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/HTMLInputElement/setSelectionRange" target="_blank" rel="noopener">setSelectionRange</a> 。</p>
<blockquote>
<p>element.setSelectionRange(selectionStart, selectionEnd [, selectionDirection]);</p>
</blockquote>
<ul>
<li>selectionStart 被选中的第一个字符的位置索引，从 0 开始。</li>
<li>selectionEnd 被选中的最后一个字符的 下一个 位置索引。</li>
<li>selectionDirection 选择方向的字符串。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$input.setSelectionRange(<span class="number">0</span>, <span class="number">6</span>)</span><br><span class="line"><span class="comment">// $input.select() // 全部选中</span></span><br><span class="line">$input.focus()</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662389649885-df19671d-6b75-4375-8ea1-310481544199.gif" alt="setSelectionRange.gif"></p>
<h3 id="聚焦到某一位置"><a href="#聚焦到某一位置" class="headerlink" title="聚焦到某一位置"></a>聚焦到某一位置</h3><p>如果我们想把光标移动到 😃😄😁 后面，其实是将选区起始位置设置相同的效果</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$input.setSelectionRange(<span class="number">6</span>, <span class="number">6</span>)</span><br><span class="line">$input.focus()</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662389674758-aec15344-10ed-40a0-be3c-34cd2cde513b.gif" alt="setSelectionRange1.gif"></p>
<h3 id="还原之前的选区"><a href="#还原之前的选区" class="headerlink" title="还原之前的选区"></a>还原之前的选区</h3><p>有些场景，我们选择了当前<code>input</code>文本框选区，要去做别的操作，回来后要恢复选区，这时在做别的操作之前就要将选区位置存下来，会用到<code>selectionStart</code>和 <code>selectionEnd</code>两个属性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$input.addEventListener(<span class="string">'mouseup'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">this</span>.pos = &#123;</span><br><span class="line">    start: $input.selectionStart,</span><br><span class="line">    end: $input.selectionEnd</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; start, end &#125; = <span class="keyword">this</span>.pos</span><br><span class="line">$input.setSelectionRange(start, end)</span><br><span class="line">$input.focus()</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662389710497-a13651e7-3f6e-40d5-82dd-f2f4b9ad5901.gif" alt="setSelectionRange2.gif"></p>
<h3 id="在指定选区插入（替换）内容"><a href="#在指定选区插入（替换）内容" class="headerlink" title="在指定选区插入（替换）内容"></a>在指定选区插入（替换）内容</h3><p>指定文本输入框的某个位置插入内容或者替换选区的内容，可以使用 <a href="https://developer.mozilla.org/en-US/docs/Web/API/HTMLInputElement/setRangeText" target="_blank" rel="noopener">setRangeText</a> 实现。</p>
<blockquote>
<p>setRangeText(replacement)<br>setRangeText(replacement, start, end, selectMode)</p>
</blockquote>
<p>这个方法有 2 种形式，第二种形式有 4 个参数：</p>
<ul>
<li>第一个参数<code>replacement</code>是替换文本；</li>
<li><code>start</code>和 <code>end</code>是起始位置，默认值该元素当前选中的区域的位置；</li>
<li>最后一个参数<code>selectMode</code>是替换后选区的状态，它有 4 个状态：select（替换后选中）、start（替换后光标位于替换词之前）、end（替换后光标位于替换词之后）和 preserve（默认值，尝试保留选区）；</li>
</ul>
<p>我们将光标或者选区位置插入或者替换文本 😂😂😂，可以这样</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$input.setRangeText(<span class="string">'😂😂😂'</span>)</span><br><span class="line">$input.focus()</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662389727309-4831ce20-3bea-4b0c-9bec-86219a9c6427.gif" alt="setRangeText.gif"><br>下面再来看看第二种有 4 个参数形式，发现会在我们指定的起始位置插入内容后，当前的选区和光标尝试保留。替换后选区的状态另外 3 种场景大家可以自行测试。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$input.setRangeText(<span class="string">'😂😂😂'</span>, <span class="number">8</span>, <span class="number">8</span>, <span class="string">'preserve'</span>)</span><br><span class="line">$input.focus()</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662389742937-1b7b8b0c-2e1d-482a-8e45-f86b3c01620a.gif" alt="setRangeText1.gif"><br>关于选区的操作在 input/textarea 输入框中的操作常用的差不多就这些，下面简单总结一下<br><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/22627045/1663148689420-1c042136-3b5a-4f15-ab7f-0c706a62568e.jpeg" alt=""></p>
<h2 id="富文本中操作光标选区——Selection-amp-Range"><a href="#富文本中操作光标选区——Selection-amp-Range" class="headerlink" title="富文本中操作光标选区——Selection &amp; Range"></a>富文本中操作光标选区——Selection &amp; Range</h2><h3 id="设置富文本"><a href="#设置富文本" class="headerlink" title="设置富文本"></a>设置富文本</h3><p>首先富文本元素是可编辑元素，可以在元素上看到光标，除了表单元素，还有给普通元素添加属性可以转换文富文本元素，可以通过一下三种方式转换。</p>
<ul>
<li>给元素添加属性 <code>contenteditable=&quot;true&quot;</code>；</li>
<li>添加 CSS 属性 <code>-webkit-user-modify: &quot;read-write&quot;</code>；</li>
<li>通过 js 的 <code>document.designMode=&quot;on&quot;</code>方式设置；</li>
</ul>
<h3 id="Selection-amp-Range"><a href="#Selection-amp-Range" class="headerlink" title="Selection &amp; Range"></a>Selection &amp; Range</h3><p>在富文本中对光标及选区的操作，不得不提 JavaScript 的两个原生对象： <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Selection" target="_blank" rel="noopener">Selection</a> 和 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Range/Range" target="_blank" rel="noopener">Range</a> 。</p>
<ul>
<li><strong>Selection</strong> 对象表示用户选择的文本范围或插入符号的当前位置。它代表页面中的文本选区，可能横跨多个元素。文本选区由用户拖拽鼠标经过文字而产生。要获取用于检查或修改的 <code>Selection</code> 对象，请调用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/getSelection" target="_blank" rel="noopener">window.getSelection()</a>。</li>
<li><strong>Range</strong> 对象表示包含节点和部分文本节点的文档片段。通过 <code>selection</code>对象获得的 <code>range</code>对象才是我们操作光标的重点。</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/22627045/1662215604275-69e9f544-0b5a-4ba1-acf7-2d6a49928d03.png" alt="image.png"><br>大家可能注意到 <code>getRangeAt(0)</code>，选区可能会有多个 <code>range</code>? 还真是，在 Firefox 支持多个选区，通过 <code>cmd</code>键（<code>windows</code>上是 <code>ctrl</code>键）可以实现多选区。<br><img src="https://cdn.nlark.com/yuque/0/2022/png/22627045/1662216141776-85c105ca-898d-4821-b132-cd703eaab3df.png" alt="image.png"><br>再看一个 range 返回的一个属性，<code>collapsed</code>，表示选区的起点与终点是否重叠。当<code>collapsed</code>为<code>true</code>时，选中区域被压缩成一个点，对于普通的元素，可能什么都看不到，如果是在可编辑元素上，那这个被压缩的点就变成了可以闪烁的光标。</p>
<h3 id="主动选中富文本的某个节点"><a href="#主动选中富文本的某个节点" class="headerlink" title="主动选中富文本的某个节点"></a>主动选中富文本的某个节点</h3><p>选中富文本中的某个独立标签，可以用到两个 API，<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Range/selectNode" target="_blank" rel="noopener">Range.selectNode()</a> 和 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Range/selectNodeContents" target="_blank" rel="noopener">Range.selectNodeContent()</a>，两者不同的是前者包括节点自身，后者不包括自身。比如我们想独立选中富文本的第二个子元素<code>&lt;span style=&quot;color: #00965e;&quot;&gt;Selection&lt;/span&gt;</code> ，使用 <code>Range.selectNode()</code> API 选中元素，删除的是整个元素，再输入内容是没有样式的。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> $span = $input.childNodes[<span class="number">1</span>]</span><br><span class="line">range.selectNode($span)</span><br><span class="line">selection.removeAllRanges()</span><br><span class="line">selection.addRange(range)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662435977354-b19ed561-61ec-4d8f-a184-9ae73f1f9b07.gif" alt="selectNode1.gif"><br>当然部分浏览器（比如 Chrome104）是有差异的，在删除整个节点后，新输入的内容时会插入一个标签（<code>font</code>）并集成之前的样式。<br><img src="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662436107528-1001e4af-e644-4571-8d26-ee085792e019.gif" alt="selectNode.gif"><br>使用 <code>Range.selectNodeContents()</code> API 选中的是节点内部内容，当删除选中内容后，节点本身还在。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> $span = $input.childNodes[<span class="number">1</span>]</span><br><span class="line">range.selectNodeContents($span)</span><br><span class="line">selection.removeAllRanges()</span><br><span class="line">selection.addRange(range)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662436465512-d56fa927-a301-4e5a-b039-5e32c4443b07.gif" alt="selectNode2.gif"><br>以上是对富文本中单个节点的选中操作，然而，实际上富文本中的节点可能是嵌套或者平行的，怎样跨多个元素去选中操作呢？</p>
<h3 id="主动选中富文本的某一区域"><a href="#主动选中富文本的某一区域" class="headerlink" title="主动选中富文本的某一区域"></a>主动选中富文本的某一区域</h3><p>表单输入框只有单一文本，而富文本元素或者普通元素包含多个元素。当主动选中页面某一区域，先要创建一个<code>Range</code>对象，可能会跨多个元素，所以要设置选区的起始节点，分别是 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Range/setStart" target="_blank" rel="noopener">Range.setStart()</a> 和 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Range/setEnd" target="_blank" rel="noopener">Range.setEnd()</a> 方法。</p>
<blockquote>
<p>range.setStart(startNode, startOffset);<br>range.setEnd(endNode, endOffset);</p>
</blockquote>
<ul>
<li>startNode 开始节点</li>
<li>startOffset 从 startNode 的开始位置算起的偏移量</li>
<li>endNode 结束节点</li>
<li>endOffset 从 endNode 的结束位置算起的偏移量</li>
</ul>
<p>上面是设置选区范围，然后将其添加到选区并选中 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Selection/addRange" target="_blank" rel="noopener">Selection.addRange()</a>。不过，一般在添加前，会清除之前的选区，这时就要用到 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Selection/removeAllRanges" target="_blank" rel="noopener">Selection.removeAllRanges()</a> 。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> selection = <span class="built_in">document</span>.getSelection()</span><br><span class="line"><span class="keyword">const</span> range = <span class="built_in">document</span>.createRange()</span><br><span class="line">range.setStart($input.firstChild, <span class="number">0</span>)</span><br><span class="line">range.setEnd($input.firstChild, <span class="number">4</span>)</span><br><span class="line">selection.removeAllRanges()</span><br><span class="line">selection.addRange(range)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662390599870-23189fbe-5149-43dc-8492-5d06e425464e.gif" alt="addRange.gif"><br>注意这里取富文本元素的第一个子节点（文本节点），而不是元素本身，否则就会超出偏移量，出现报错。因为在计算元素节点和文本节点偏移量是有差别的：</p>
<blockquote>
<p>如果起始节点类型是 Text、Comment 或 CDATASection 之一，那么 startOffset 指的是从起始节点算起字符的偏移量。 对于其他 Node 类型节点，startOffset 是指从起始结点开始算起子节点的偏移量。</p>
</blockquote>
<p>那么问题来了，如果我想选中富文本开头这一段 <code>😃😄😁&lt;span style=&quot;color: #00965e;&quot;&gt;Selection&lt;/span&gt; 对象</code>，怎样实现呢？<br>对于比较复杂的富文本元素结构，要实现任意区间选中，关键要找到起始节点和结束节点，以及它们各自的偏移量。<br><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/22627045/1662446157651-fd9d9bad-f924-4c19-b706-7b94d20751e8.jpeg" alt=""></p>
<p>好像没有更好的原生方法可以借助，这里有一种方案，首先遍历出富文本包含所有的文本节点，然后记录每个节点边界的偏移量，查找出满足区间条件的起始和结束节点，最后从起始和结束节点中计算各自需要的文本偏移量。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取所有文本节点及其偏移量</span></span><br><span class="line"><span class="comment"> * @param &#123;HTMLElement&#125; wrapDom 最外层节点</span></span><br><span class="line"><span class="comment"> * @param &#123;Number&#125; start 开始位置</span></span><br><span class="line"><span class="comment"> * @param &#123;Number&#125; end 结束位置</span></span><br><span class="line"><span class="comment"> * @returns</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getNodeAndOffset</span>(<span class="params">wrapDom, start = <span class="number">0</span>, end = <span class="number">0</span></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> txtList = []</span><br><span class="line">  <span class="keyword">const</span> map = <span class="function"><span class="keyword">function</span> (<span class="params">children</span>) </span>&#123;</span><br><span class="line">    ;[...children].forEach(<span class="function">(<span class="params">el</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (el.nodeName === <span class="string">'#text'</span>) &#123;</span><br><span class="line">        txtList.push(el)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        map(el.childNodes)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 递归遍历，提取出所有 #text</span></span><br><span class="line">  map(wrapDom.childNodes)</span><br><span class="line">  <span class="comment">// 计算文本的位置区间</span></span><br><span class="line">  <span class="keyword">const</span> clips = txtList.reduce(<span class="function">(<span class="params">arr, item, index</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> end = item.textContent.length + (arr[index - <span class="number">1</span>] ? arr[index - <span class="number">1</span>][<span class="number">2</span>] : <span class="number">0</span>)</span><br><span class="line">    arr.push([item, end - item.textContent.length, end])</span><br><span class="line">    <span class="keyword">return</span> arr</span><br><span class="line">  &#125;, [])</span><br><span class="line">  <span class="comment">// 查找满足条件的范围区间</span></span><br><span class="line">  <span class="keyword">const</span> startNode = clips.find(<span class="function">(<span class="params">el</span>) =&gt;</span> start &gt;= el[<span class="number">1</span>] &amp;&amp; start &lt; el[<span class="number">2</span>])</span><br><span class="line">  <span class="keyword">const</span> endNode = clips.find(<span class="function">(<span class="params">el</span>) =&gt;</span> end &gt;= el[<span class="number">1</span>] &amp;&amp; end &lt; el[<span class="number">2</span>])</span><br><span class="line">  <span class="keyword">return</span> [startNode[<span class="number">0</span>], start - startNode[<span class="number">1</span>], endNode[<span class="number">0</span>], end - endNode[<span class="number">1</span>]]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有了这个我们自己封装的工具方法，就可以选中任意文字区间，而不用考虑富文本的元素结构。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> selection = <span class="built_in">document</span>.getSelection()</span><br><span class="line"><span class="keyword">const</span> range = <span class="built_in">document</span>.createRange()</span><br><span class="line"><span class="keyword">const</span> nodes = <span class="keyword">this</span>.getNodeAndOffset($input, <span class="number">4</span>, <span class="number">17</span>)</span><br><span class="line">range.setStart(nodes[<span class="number">0</span>], nodes[<span class="number">1</span>])</span><br><span class="line">range.setEnd(nodes[<span class="number">2</span>], nodes[<span class="number">3</span>])</span><br><span class="line">selection.removeAllRanges()</span><br><span class="line">selection.addRange(range)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662448203808-f82a4bb4-6eaf-4977-983e-42209e1b1c15.gif" alt="getNodeAndOffset.gif"></p>
<h3 id="聚焦到某一位置-1"><a href="#聚焦到某一位置-1" class="headerlink" title="聚焦到某一位置"></a>聚焦到某一位置</h3><p>通过上面已实现选中任意区间文字，再来看将光标聚焦到某一位置，就简单多了，只选将起始和结束范围位置设置相同即可。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> selection = <span class="built_in">document</span>.getSelection()</span><br><span class="line"><span class="keyword">const</span> range = <span class="built_in">document</span>.createRange()</span><br><span class="line"><span class="keyword">const</span> nodes = <span class="keyword">this</span>.getNodeAndOffset($input, <span class="number">7</span>, <span class="number">7</span>)</span><br><span class="line">range.setStart(nodes[<span class="number">0</span>], nodes[<span class="number">1</span>])</span><br><span class="line">range.setEnd(nodes[<span class="number">2</span>], nodes[<span class="number">3</span>])</span><br><span class="line">selection.removeAllRanges()</span><br><span class="line">selection.addRange(range)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662449255433-9315d09c-e752-4ffb-a975-a54c856796e5.gif" alt="getNodeAndOffset1.gif"></p>
<h3 id="还原之前的选区-1"><a href="#还原之前的选区-1" class="headerlink" title="还原之前的选区"></a>还原之前的选区</h3><p>同文本输入框保存当前的光标位置，在富文本里，可以将整个选区都保存下来，然后在后面复原选区。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 保存光标</span></span><br><span class="line">$input.addEventListener(<span class="string">'mouseup'</span>, () =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> selection = <span class="built_in">document</span>.getSelection()</span><br><span class="line">  <span class="keyword">const</span> range = selection.getRangeAt(<span class="number">0</span>)</span><br><span class="line">  <span class="keyword">this</span>.lastRange = range</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// 还原光标</span></span><br><span class="line"><span class="keyword">const</span> selection = <span class="built_in">document</span>.getSelection()</span><br><span class="line"><span class="keyword">const</span> range = <span class="built_in">document</span>.createRange()</span><br><span class="line">selection.removeAllRanges()</span><br><span class="line">selection.addRange(<span class="keyword">this</span>.lastRange)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662453084252-763866a8-f74d-4938-ba88-bbc2fbf85920.gif" alt="addRange1.gif"></p>
<h3 id="在指定选区插入（替换）内容-1"><a href="#在指定选区插入（替换）内容-1" class="headerlink" title="在指定选区插入（替换）内容"></a>在指定选区插入（替换）内容</h3><p>在选区插入内容，可以使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Range/insertNode" target="_blank" rel="noopener">Range.insertNode()</a> 方法，它表示在选区的起点处插入一个节点，并且不会替换当前已经选中的，如果需要替换，可以先删除，删除选区可以用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Range/deleteContents" target="_blank" rel="noopener">Range.deleteContent()</a> 方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> $text = <span class="built_in">document</span>.createTextNode(<span class="string">'😂😂😂'</span>)</span><br><span class="line"><span class="keyword">this</span>.lastRange.deleteContents()</span><br><span class="line"><span class="keyword">this</span>.lastRange.insertNode($text)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662456538724-b365a830-e9dc-4472-aa8f-07e69371008c.gif" alt="deleteContent.gif"><br>从上面客服发现，插入内容后，内容是被选区选中状态，如果希望光标在插入的内容后面，可以使用 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Range/setStartAfter" target="_blank" rel="noopener">Range.setStartAfter()</a> 设置选区的起点为元素的后面，默认选区的终点在元素的后面 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Range/setEndAfter" target="_blank" rel="noopener">Range.setEndAfter()</a>，无须设置。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.lastRange.setStartAfter($text)</span><br><span class="line">$input.focus()</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662457953619-1679fb5f-23fb-43cb-b34a-54d1b3b0c4df.gif" alt="setStartAfter.gif"><br>同样，也可以使用 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Range/setEndBefore" target="_blank" rel="noopener">Range.setEndBefore</a> 和 <a href="https://developer.mozilla.org/en-US/docs/Web/API/Range/setStartBefore" target="_blank" rel="noopener">setStartBefore</a>将光标设置到内容的前面。</p>
<h3 id="给指定选区包裹标签"><a href="#给指定选区包裹标签" class="headerlink" title="给指定选区包裹标签"></a>给指定选区包裹标签</h3><p>还有一些比较高级的用法应用，比如给某句话加背景标记效果，类似 word 文档文字选中加背景色。可以通过 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Range/surroundContents" target="_blank" rel="noopener">Range.surroundContents()</a> 方法实现。</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662462012337-424061e8-e1fc-4cbb-8c49-b6072ca68056.gif" alt="surroundContents.gif"><br>不过，当选区包含多个元素，也就是断开了一个非 text 节点，只包含了节点的其中一个边界，就会抛出异常。<br>那么怎样可以规避这个问题，实现跨多个节点选中标记呢？答案是 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Range/extractContents" target="_blank" rel="noopener">extractContents()</a>，它会将我们的选区多节点移动到 <code>DocumentFragment</code> 对象，需要注意的是</p>
<blockquote>
<p>使用 DOM 事件添加的事件监听器在提取期间不会保留。HMTL 属性事件将按 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Node/cloneNode" target="_blank" rel="noopener">Node.cloneNode()</a> 方法原样保留和复制。HTML id 属性也会被克隆，如果提取了部分选定的节点并将其附加到文档中，则可能导致无效的文档。</p>
</blockquote>
<p>用标签包裹该文档片段，然后插入。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> $mark = <span class="built_in">document</span>.createElement(<span class="string">'mark'</span>)</span><br><span class="line"><span class="comment">// this.lastRange.surroundContents($mark)</span></span><br><span class="line"><span class="keyword">const</span> fragments = <span class="keyword">this</span>.lastRange.extractContents()</span><br><span class="line">$mark.append(fragments)</span><br><span class="line"><span class="keyword">this</span>.lastRange.insertNode($mark)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662894067034-48b18544-3caf-4c99-91aa-9fa3207eafb4.gif" alt="extractContents.gif"></p>
<h3 id="光标-选区的位置坐标"><a href="#光标-选区的位置坐标" class="headerlink" title="光标/选区的位置坐标"></a>光标/选区的位置坐标</h3><p>有时我们想确定文本区域中被选中的部分或者光标的视窗坐标，以此可以将类似备注或者悬浮框定位到附近。这里可以使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Range/getBoundingClientRect" target="_blank" rel="noopener">Range.getBoundingClientRect()</a> API，它返回一个 DOMRect 对象，该对象将范围中的内容包围起来；即该对象是一个将范围内所有<br>元素包围起来的矩形。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> pos = <span class="keyword">this</span>.lastRange.getBoundingClientRect()</span><br><span class="line"><span class="keyword">const</span> highlight = <span class="built_in">document</span>.getElementById(<span class="string">'highlight'</span>)</span><br><span class="line">highlight.style.left = <span class="string">`<span class="subst">$&#123;pos.x&#125;</span>px`</span></span><br><span class="line">highlight.style.top = <span class="string">`<span class="subst">$&#123;pos.y&#125;</span>px`</span></span><br><span class="line">highlight.style.width = <span class="string">`<span class="subst">$&#123;pos.width&#125;</span>px`</span></span><br><span class="line">highlight.style.height = <span class="string">`<span class="subst">$&#123;pos.height&#125;</span>px`</span></span><br></pre></td></tr></table></figure>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-id">#highlight</span> &#123;</span><br><span class="line">  <span class="attribute">position</span>: absolute;</span><br><span class="line">  <span class="attribute">background-color</span>: aqua;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662903500575-0654dcc3-7084-4f44-ad79-e535855ebe8b.gif" alt="getBoundingClientRect.gif"><br>选中了 3 行，但不是完整的 3 行，给回的信息是一个最小包裹选区的矩形位置坐标，如果还需要知道选取中每个元素更详细的位置坐标，可以使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Range/getClientRects" target="_blank" rel="noopener">Range.getClientRects()</a>，它返回的是一个 DOMRect 对象列表，表示 Range 在屏幕上所占的区域。这个列表相当于汇集了范围中所有元素调用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Element/getClientRects" target="_blank" rel="noopener">Element.getClientRects()</a>方法所得到的结果。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.lastRange.getClientRects()</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/22627045/1662904506911-91a30004-51d1-4dd8-8d03-5f7743d9caf4.png" alt="image.png"><br><img src="https://cdn.nlark.com/yuque/0/2022/png/22627045/1662904530240-a2695b2a-09bf-40cb-b75c-1f04e862b0fc.png" alt="image.png"><br>Selection&amp;Range 的 API 很多，常用的大致以上列举的，同样简单总结一下<br><img src="https://cdn.nlark.com/yuque/0/2022/jpeg/22627045/1663151006797-58eaa2f3-bf49-4ff3-a493-fff785bfa05a.jpeg" alt=""></p>
<h2 id="的功能实现"><a href="#的功能实现" class="headerlink" title="@的功能实现"></a>@的功能实现</h2><p>如果你已经熟悉了上面的「基操」，那么对于实现一个@功能已经成功了一半，剩下的一半就是思路了，大致分为如下几步：</p>
<ol>
<li>监听用户输入了<code>@</code>字符，展示用户列表；</li>
<li>点击用户，导致输入框失焦，及时保存光标信息；</li>
<li>点击完成，用户列表隐藏，恢复输入框的光标，然后在光标后插入用户名；</li>
</ol>
<p>首先我们写好 <code>HTML</code>，<code>CSS</code> 部分在这里省略</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 富文本聊天消息输入框 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span></span></span><br><span class="line"><span class="tag">  <span class="attr">class</span>=<span class="string">"chat-input"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">ref</span>=<span class="string">"chatInput"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">contenteditable</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">  <span class="attr">placeholder</span>=<span class="string">"请输入内容"</span></span></span><br><span class="line"><span class="tag">  @<span class="attr">input</span>=<span class="string">"inputChatContent"</span></span></span><br><span class="line"><span class="tag">  @<span class="attr">blur</span>=<span class="string">"chatContentBlur"</span></span></span><br><span class="line"><span class="tag">  @<span class="attr">mouseup</span>=<span class="string">"chatContentMouseup"</span></span></span><br><span class="line"><span class="tag">&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 用户列表浮窗 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"popper"</span> <span class="attr">v-show</span>=<span class="string">"isShowUserList"</span> <span class="attr">ref</span>=<span class="string">"popper"</span> <span class="attr">:style</span>=<span class="string">"popperStyle"</span> <span class="attr">v-click-out-hide</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">"(item, index) in userList"</span> <span class="attr">:key</span>=<span class="string">"index"</span> @<span class="attr">click</span>=<span class="string">"selectUser(item)"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">el-row</span>&gt;</span>&#123;&#123;item.name&#125;&#125;<span class="tag">&lt;/<span class="name">el-row</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>接着我们监听富文本的<code>input</code>事件，当监听到 @ 字符，展示用户列表，否则隐藏。于此同时，使用 Range.getBoundingClientRect() 获取光标的位置，这样才能将用户列表浮框定位到光标附近。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 输入聊天内容</span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; ev</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">inputChatContent(ev) &#123;</span><br><span class="line">  <span class="keyword">if</span> (ev.data === <span class="string">'@'</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> pos = <span class="keyword">this</span>.getCaretPos()</span><br><span class="line">    <span class="keyword">this</span>.showUserList()</span><br><span class="line">    <span class="keyword">this</span>.$nextTick(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.setUserListPos(pos)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.hideUserList()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取光标位置</span></span><br><span class="line"><span class="comment"> * @returns</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">getCaretPos() &#123;</span><br><span class="line">  <span class="keyword">const</span> range = <span class="keyword">this</span>.getRange()</span><br><span class="line">  <span class="keyword">const</span> pos = range.getBoundingClientRect()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> pos</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 设置用户列表的位置</span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; pos</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">setUserListPos(pos) &#123;</span><br><span class="line">  <span class="keyword">const</span> $popper = <span class="keyword">this</span>.$refs.popper</span><br><span class="line">  <span class="keyword">const</span> panelWidth = $popper.offsetWidth</span><br><span class="line">  <span class="keyword">const</span> panelHeight = $popper.offsetHeight</span><br><span class="line">  <span class="keyword">const</span> &#123; x, y &#125; = pos</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.popperStyle = &#123;</span><br><span class="line">    top: y - panelHeight - <span class="number">20</span> + <span class="string">'px'</span>,</span><br><span class="line">    left: x - panelWidth / <span class="number">2</span> + <span class="string">'px'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">hideUserList() &#123;</span><br><span class="line">  <span class="keyword">this</span>.isShowUserList = <span class="literal">false</span></span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">showUserList() &#123;</span><br><span class="line">  <span class="keyword">this</span>.isShowUserList = <span class="literal">true</span></span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p>当点击用户列表时，输入框会失焦，此时先将光标保存起来，同时创建将要插入的用户名文本节点，然后恢复光标，再 <code>Range.insetNode()</code> 将用户名文本节点 <code>Range.insetNode()</code> 插入到选区，最后 <code>Selection.removeAllRanges()</code> 移除所有页面选区，<code>Selection.addRange()</code> 插入当前选区。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 选择用户</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">selectUser(user) &#123;</span><br><span class="line">  <span class="comment">// 让失焦事件先执行</span></span><br><span class="line">  setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.hideUserList()</span><br><span class="line">    <span class="keyword">this</span>.insertContent(user)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 恢复光标</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">restoreCaret() &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.lastRange) &#123;</span><br><span class="line">    <span class="keyword">const</span> selection = <span class="built_in">window</span>.getSelection()</span><br><span class="line">    selection.removeAllRanges()</span><br><span class="line">    selection.addRange(<span class="keyword">this</span>.lastRange)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 插入内容</span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; data</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">insertContent(data) &#123;</span><br><span class="line">  <span class="keyword">this</span>.restoreCaret() <span class="comment">// 还原光标</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> selection = <span class="built_in">window</span>.getSelection()</span><br><span class="line">  <span class="keyword">const</span> range = selection.getRangeAt(<span class="number">0</span>)</span><br><span class="line">  range.collapse(<span class="literal">false</span>) <span class="comment">// 折叠选区，光标移到最后</span></span><br><span class="line">  range.insertNode(data.content)</span><br><span class="line">  range.collapse(<span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line">  selection.removeAllRanges()</span><br><span class="line">  selection.addRange(range)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id=""><a href="#" class="headerlink" title=""></a><img src="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662907721684-7990ab06-9e4c-4c6c-b67b-ad04ef8a55c6.gif" alt="at1.gif"></h2><h2 id="功能加强版"><a href="#功能加强版" class="headerlink" title="@功能加强版"></a>@功能加强版</h2><p>以上是简单实现了@ 功能，在实际应用中还有更多提升用户体验的地方</p>
<ul>
<li>当前通过退回键删除用户名<code>@xxx</code>，发现删除的是逐个字符，而用户更多想要的是按一下退回键，删除整个用户名；</li>
<li>发送出去怎样解析成后端能识别的特定的数据结构，并且特定的数据结构怎样转换回富文本呢？</li>
</ul>
<p><img src="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662908992043-444da205-b539-4036-b02e-6c1672e64f00.gif" alt="at2.gif"><br>暂且带这两个问题，接着怎样解决呢？</p>
<h3 id="实现整体删除用户名"><a href="#实现整体删除用户名" class="headerlink" title="实现整体删除用户名"></a>实现整体删除用户名</h3><p>首先想到的是用户名插入富文本是一个标签，按一下退回键，就能删除整个标签？答案是不能，富文本标签里的文字在没有选中情况下都是逐个删除。除非该元素是不可编辑元素 <code>span.contentEditable = false</code>。<br><img src="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662909400591-181e6928-75f6-40a9-80a2-6f163109b91d.gif" alt="at3.gif"><br>这里要将 <code>@xxx</code>放入不可编辑标签中，删除的时候才能一起删。此时会有一个问题，每次插入用户标签后，多出一个@ 字符，所以在之前已经输入的 @ 字符就需要在插入标签前需要删除掉。具体实现是找到选区所在的开始节点 <code>Range.startContainer</code>，再找到选区结束位置的偏移量 <code>Range.endOffset</code> ，正常情况下选区结束位置的前一个就是 @字符，选中删除即可。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 删除输入框中光标位置现有的@字符</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">deleteCaretAtCode() &#123;</span><br><span class="line">  <span class="keyword">const</span> range = <span class="keyword">this</span>.getRange()</span><br><span class="line">  <span class="comment">// 光标开始节点和光标在节点上的偏移量，找到光标准确位置，选中光标位置前一个字符范围并删除，</span></span><br><span class="line">  <span class="keyword">const</span> node = range.startContainer</span><br><span class="line">  <span class="keyword">const</span> end = range.endOffset</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 开始节点内容最后一个字符是@，删除，否则不删除</span></span><br><span class="line">  <span class="keyword">if</span> (node.textContent[end - <span class="number">1</span>] === <span class="string">'@'</span>) &#123;</span><br><span class="line">    range.setStart(node, end ? end - <span class="number">1</span> : <span class="number">0</span>)</span><br><span class="line">    range.deleteContents()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 转换要插入光标位置的内容</span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; data</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">parseContent(data) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; type = <span class="string">'text'</span>, name &#125; = data</span><br><span class="line">  <span class="keyword">let</span> content = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// type 是插入内容类型，可能是文本、@标签、图片、表情等</span></span><br><span class="line">  <span class="keyword">if</span> (type === <span class="string">'text'</span>) &#123;</span><br><span class="line">    content = <span class="built_in">document</span>.createTextNode(name)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type === <span class="string">'at'</span>) &#123;</span><br><span class="line">    <span class="comment">// 删除输入框中光标位置现有的@字符</span></span><br><span class="line">    <span class="keyword">this</span>.deleteCaretAtCode()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> $span = <span class="built_in">document</span>.createElement(<span class="string">'span'</span>)</span><br><span class="line">    $span.contentEditable = <span class="literal">false</span></span><br><span class="line">    $span.classList.add(<span class="string">'tag'</span>)</span><br><span class="line">    $span.innerHTML = <span class="string">`@<span class="subst">$&#123;name&#125;</span>`</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 插入一个空格字符（\u0010）到@标签后面，可以解决部分浏览器上光标在聊天输入框后面</span></span><br><span class="line">    <span class="keyword">const</span> $space = <span class="built_in">document</span>.createTextNode(<span class="string">'\u0010'</span>)</span><br><span class="line">    <span class="keyword">const</span> frag = <span class="built_in">document</span>.createDocumentFragment()</span><br><span class="line"></span><br><span class="line">    frag.appendChild($span)</span><br><span class="line">    frag.appendChild($space)</span><br><span class="line"></span><br><span class="line">    content = frag</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> content</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 插入内容</span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; data</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">insertContent(data) &#123;</span><br><span class="line">  <span class="keyword">this</span>.restoreCaret() <span class="comment">// 还原光标</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> selection = <span class="built_in">window</span>.getSelection()</span><br><span class="line">  <span class="keyword">const</span> range = selection.getRangeAt(<span class="number">0</span>)</span><br><span class="line">  range.collapse(<span class="literal">false</span>) <span class="comment">// 折叠选区，光标移到最后</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> pc = <span class="keyword">this</span>.parseContent(data)</span><br><span class="line">  range.insertNode(pc)</span><br><span class="line">  range.collapse(<span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line">  selection.removeAllRanges()</span><br><span class="line">  selection.addRange(range)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662910427167-f2a84f0b-ff53-47e1-864e-38f05e15bfb4.gif" alt="at4.gif"></p>
<h3 id="一些兼容处理"><a href="#一些兼容处理" class="headerlink" title="一些兼容处理"></a>一些兼容处理</h3><p>可能你已经注意到了，在用户标签<code>@xxx</code>后面追加了一个空格字符，这样光标可以显示出来，不过在用退格键需要按两次删除标签，这里具体的要看业务需要了。<br>注意的是在 Mac Chrome（V104）上，如果在标签后面不追加字符，光标会在外层富文本标签后面，在非编辑标签后加任意字符是正常的。<img src="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1663148352142-96a6a343-c4f3-4185-9b7b-b6724faf9e9b.gif" alt="chat-input-cursor-out.gif"><br>经过测试 Firefox 浏览器有这样的 bug：用户标签<code>@xxx</code>没有正确的插入到富文本输入框的位置，而是插入到了用户列表点击的那一项上了。<img src="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662968166386-06ffeb53-6b4a-4a4d-8281-26bb8f3838e1.gif" alt="firefox.gif"><br>大胆推测 Firefox 将普通元素也可以设置光标，这样点击用户列表某一项元素时，该元素获得光标，再获取新选区 <code>selection.getRangeAt(0)</code>其实是在点击的这个元素上，非恢复的富文本输入框上，然后插入用户标签，也就是上面的情景。<br>这里我的解决方法是将用户列表项设置为不可选中的，自然就无法获取光标。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.popper</span> <span class="selector-tag">li</span> &#123;</span><br><span class="line">  <span class="comment">/* 用户不能选中文本 firfox 非编辑编辑元素也可选中 */</span></span><br><span class="line">  <span class="attribute">user-select</span>: none;</span><br><span class="line">  <span class="attribute">-webkit-user-select</span>: none;</span><br><span class="line">  <span class="attribute">list-style</span>: none;</span><br><span class="line">  <span class="attribute">padding</span>: <span class="number">10px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662969574165-f5ad5028-0b3c-4a82-a70f-8d978cf19362.gif" alt="Firefox1.gif"><br>我们再看看再 Safari 上的表现<br><img src="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662977831761-d5da8f13-d551-454a-b69f-be6475114777.gif" alt="Safari1.gif"><br>发现是没有按照预想的删除掉前置的<code>@</code>字符的，查看控制台有报错<br><img src="https://cdn.nlark.com/yuque/0/2022/png/22627045/1662977805511-ffbb8962-4456-42fe-917c-ed310575d9b8.png" alt="image.png"><br>大致意思是 <code>selection.getRangeAt(0)</code>中第 0 位是超出允许的范围的，难道在输入框失去焦点的情景下，Safari 默认将选区给清空了？通过实验发现确实如此</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 输入框失去焦点和获取焦点时打印选区个数</span></span><br><span class="line"><span class="keyword">const</span> selection = <span class="built_in">window</span>.getSelection()</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'selection.rangeCount: '</span>, selection.rangeCount)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662978608482-02437102-37b2-45c2-9b98-042ba882c5c1.gif" alt="Safari2.gif"><br>而正常其他浏览器选区个数保持不变<br><img src="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662978794016-4b5c68bf-d7e6-4765-a19d-029bce17351f.gif" alt="Safari3.gif"><br>那怎样解决这种情景呢？我们是在输入框失焦的时候保存选区的，此时 Safari 已经清空了选区，导致这个时候保存的选区是空的，因此我们要将选区保存前置一下，在输入<code>@</code>字符时候就保存一下选区（光标），可以这样做</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 输入聊天内容</span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; ev</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">inputChatContent(ev) &#123;</span><br><span class="line">  <span class="keyword">if</span> (ev.data === <span class="string">'@'</span>) &#123;</span><br><span class="line">    <span class="comment">// 在输入@字符时候就保存一下光标</span></span><br><span class="line">    <span class="keyword">this</span>.saveCaret()</span><br><span class="line">    <span class="keyword">const</span> pos = <span class="keyword">this</span>.getCaretPos()</span><br><span class="line">    <span class="keyword">this</span>.showUserList()</span><br><span class="line">    <span class="keyword">this</span>.$nextTick(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.setUserListPos(pos)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.hideUserList()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.nlark.com/yuque/0/2022/gif/22627045/1662978984982-ce1af8a4-16a6-4aa0-8111-baa4e25bc5f8.gif" alt="Safari.gif"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文以“完美”实现一个@ 功能为引子，介绍了 input/textarea 文本输入框和富文本的选区操作。并在此基础上结合@ 功能的实现思路，边实践边改进，不乏有很多地方没有考虑周全的，仅当作学习的 demo 就好，欢迎指正。本文在线案例可以点<a href="https://wuwhs.gitee.io/demo/realize-at/">这里</a>，完～</p>

      
    </div>

    
      


    

    
    
    

    

    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>wuwhs</li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://wuwhs.gitee.io/2022/09/15/realize-at/" title="realize-at">https://wuwhs.gitee.io/2022/09/15/realize-at/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明出处！</li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/javascript-html5/" rel="tag"># javascript html5</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2021/12/01/style/" rel="next" title="组员重构代码千奇百怪，直接JS、ES6和Vue规范给一梭子">
                <i class="fa fa-chevron-left"></i> 组员重构代码千奇百怪，直接JS、ES6和Vue规范给一梭子
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.png"
                alt="wuwhs" />
            
              <p class="site-author-name" itemprop="name">wuwhs</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">71</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">12</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">39</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/wuwhs" target="_blank" title="GitHub" rel="external nofollow"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://segmentfault.com/u/wuwhs" target="_blank" title="Segmentfault" rel="external nofollow"><i class="fa fa-fw fa-globe"></i>Segmentfault</a>
                  
                </span>
              
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#背景"><span class="nav-number">1.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#text-textarea-文本输入框中操作光标选区"><span class="nav-number">2.</span> <span class="nav-text">text/textarea 文本输入框中操作光标选区</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#主动选中某一区域"><span class="nav-number">2.1.</span> <span class="nav-text">主动选中某一区域</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#聚焦到某一位置"><span class="nav-number">2.2.</span> <span class="nav-text">聚焦到某一位置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#还原之前的选区"><span class="nav-number">2.3.</span> <span class="nav-text">还原之前的选区</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在指定选区插入（替换）内容"><span class="nav-number">2.4.</span> <span class="nav-text">在指定选区插入（替换）内容</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#富文本中操作光标选区——Selection-amp-Range"><span class="nav-number">3.</span> <span class="nav-text">富文本中操作光标选区——Selection &amp; Range</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#设置富文本"><span class="nav-number">3.1.</span> <span class="nav-text">设置富文本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Selection-amp-Range"><span class="nav-number">3.2.</span> <span class="nav-text">Selection &amp; Range</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#主动选中富文本的某个节点"><span class="nav-number">3.3.</span> <span class="nav-text">主动选中富文本的某个节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#主动选中富文本的某一区域"><span class="nav-number">3.4.</span> <span class="nav-text">主动选中富文本的某一区域</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#聚焦到某一位置-1"><span class="nav-number">3.5.</span> <span class="nav-text">聚焦到某一位置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#还原之前的选区-1"><span class="nav-number">3.6.</span> <span class="nav-text">还原之前的选区</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在指定选区插入（替换）内容-1"><span class="nav-number">3.7.</span> <span class="nav-text">在指定选区插入（替换）内容</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#给指定选区包裹标签"><span class="nav-number">3.8.</span> <span class="nav-text">给指定选区包裹标签</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#光标-选区的位置坐标"><span class="nav-number">3.9.</span> <span class="nav-text">光标/选区的位置坐标</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#的功能实现"><span class="nav-number">4.</span> <span class="nav-text">@的功能实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#"><span class="nav-number">5.</span> <span class="nav-text"></span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#功能加强版"><span class="nav-number">6.</span> <span class="nav-text">@功能加强版</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#实现整体删除用户名"><span class="nav-number">6.1.</span> <span class="nav-text">实现整体删除用户名</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#一些兼容处理"><span class="nav-number">6.2.</span> <span class="nav-text">一些兼容处理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">7.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2017 – <span itemprop="copyrightYear">2023</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">copyright by wuwh's blog</span>

  

  
</div>


  










        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>












  













  



  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/reading_progress/reading_progress.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.4.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.4.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.0"></script>



  



  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  

  
  

  

  

  

  

  

</body>
</html>
